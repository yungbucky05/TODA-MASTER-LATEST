# Driver Flag System - Architecture Diagram

## System Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        ADMIN PANEL                              â”‚
â”‚  - Detects violations                                           â”‚
â”‚  - Creates/Resolves flags                                       â”‚
â”‚  - Updates flagScore & flagStatus                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    FIREBASE DATABASE                            â”‚
â”‚                                                                 â”‚
â”‚  drivers/{driverId}                                             â”‚
â”‚  â”œâ”€ flagScore: 75                                               â”‚
â”‚  â””â”€ flagStatus: "monitored"                                     â”‚
â”‚                                                                 â”‚
â”‚  driverFlags/{driverId}/{flagId}                                â”‚
â”‚  â”œâ”€ type: "LOW_CONTRIBUTIONS"                                   â”‚
â”‚  â”œâ”€ severity: "high"                                            â”‚
â”‚  â”œâ”€ points: 75                                                  â”‚
â”‚  â”œâ”€ status: "active"                                            â”‚
â”‚  â””â”€ details: {...}                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â”‚ Real-time Listeners
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   DRIVER MOBILE APP                             â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  FirebaseRealtimeDatabaseService                         â”‚  â”‚
â”‚  â”‚  â”œâ”€ getDriverFlagData()                                  â”‚  â”‚
â”‚  â”‚  â”œâ”€ observeDriverFlagData() â†’ Flow<DriverFlagData>       â”‚  â”‚
â”‚  â”‚  â”œâ”€ getDriverActiveFlags()                               â”‚  â”‚
â”‚  â”‚  â””â”€ observeDriverFlags() â†’ Flow<List<DriverFlag>>        â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                   â”‚                                             â”‚
â”‚                   â–¼                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  TODARepository                                          â”‚  â”‚
â”‚  â”‚  â”œâ”€ getDriverFlagData()                                  â”‚  â”‚
â”‚  â”‚  â”œâ”€ observeDriverFlagData()                              â”‚  â”‚
â”‚  â”‚  â”œâ”€ getDriverActiveFlags()                               â”‚  â”‚
â”‚  â”‚  â””â”€ observeDriverFlags()                                 â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                   â”‚                                             â”‚
â”‚                   â–¼                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  EnhancedBookingViewModel                                â”‚  â”‚
â”‚  â”‚  â”œâ”€ observeDriverFlagData()                              â”‚  â”‚
â”‚  â”‚  â””â”€ observeDriverFlags()                                 â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                   â”‚                                             â”‚
â”‚                   â–¼                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  DriverInterface (UI)                                    â”‚  â”‚
â”‚  â”‚                                                           â”‚  â”‚
â”‚  â”‚  State Variables:                                        â”‚  â”‚
â”‚  â”‚  â€¢ flagScore: Int                                        â”‚  â”‚
â”‚  â”‚  â€¢ flagStatus: String                                    â”‚  â”‚
â”‚  â”‚  â€¢ activeFlags: List<DriverFlag>                         â”‚  â”‚
â”‚  â”‚  â€¢ isSuspended: Boolean                                  â”‚  â”‚
â”‚  â”‚                                                           â”‚  â”‚
â”‚  â”‚  LaunchedEffects:                                        â”‚  â”‚
â”‚  â”‚  â€¢ Monitor flag data changes                            â”‚  â”‚
â”‚  â”‚  â€¢ Monitor active flags changes                         â”‚  â”‚
â”‚  â”‚                                                           â”‚  â”‚
â”‚  â”‚  UI Components:                                          â”‚  â”‚
â”‚  â”‚  â€¢ FlagStatusBanner                                      â”‚  â”‚
â”‚  â”‚  â€¢ FlagStatusBadge                                       â”‚  â”‚
â”‚  â”‚  â€¢ ActiveFlagsList                                       â”‚  â”‚
â”‚  â”‚  â€¢ BlockedAccessScreen                                   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## UI State Machine

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              â”‚
â”‚     GOOD     â”‚  flagScore: 0-50
â”‚  (0-50 pts)  â”‚  flagStatus: "good"
â”‚      âœ…       â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ Admin adds flag (+75 pts)
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              â”‚
â”‚  MONITORED   â”‚  flagScore: 51-150
â”‚ (51-150 pts) â”‚  flagStatus: "monitored"
â”‚      ğŸ‘€       â”‚  UI: Orange warning banner
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ Admin adds more flags (+100 pts)
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              â”‚
â”‚  RESTRICTED  â”‚  flagScore: 151-300
â”‚(151-300 pts) â”‚  flagStatus: "restricted"
â”‚      âš ï¸       â”‚  UI: Red warning + contact button
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ Admin adds critical flag (+100 pts)
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              â”‚
â”‚  SUSPENDED   â”‚  flagScore: 301+
â”‚   (301+ pts) â”‚  flagStatus: "suspended"
â”‚      ğŸš«       â”‚  UI: Blocked access screen
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ Admin resolves flags
       â”‚
       â–¼
   (Returns to appropriate level based on remaining score)
```

## Data Flow Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Firebase Database                       â”‚
â”‚                                                             â”‚
â”‚  UPDATE: drivers/{driverId}/flagStatus = "monitored"       â”‚
â”‚  UPDATE: drivers/{driverId}/flagScore = 75                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â”‚ ValueEventListener triggers
               â”‚
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  observeDriverFlagData().collect { flagData ->               â”‚
â”‚      flagScore = flagData.flagScore        // 75             â”‚
â”‚      flagStatus = flagData.flagStatus      // "monitored"    â”‚
â”‚      isSuspended = (flagStatus == "suspended")               â”‚
â”‚  }                                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â”‚ State Update
               â”‚
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Compose Recomposition                   â”‚
â”‚                                                              â”‚
â”‚  if (flagStatus != "good") {                                â”‚
â”‚      FlagStatusBanner(flagStatus, flagScore)  â† SHOWS        â”‚
â”‚  }                                                           â”‚
â”‚                                                              â”‚
â”‚  if (isSuspended) {                                         â”‚
â”‚      BlockedAccessScreen()                    â† SHOWS        â”‚
â”‚  } else {                                                   â”‚
â”‚      NormalInterface()                                       â”‚
â”‚  }                                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Component Hierarchy

```
DriverInterface
â”‚
â”œâ”€â”€â”€ TopAppBar
â”‚    â”œâ”€â”€â”€ Title ("TODA Driver")
â”‚    â””â”€â”€â”€ Actions (Sign Out)
â”‚
â”œâ”€â”€â”€ TabNavigation
â”‚    â”œâ”€â”€â”€ Dashboard
â”‚    â”œâ”€â”€â”€ Bookings
â”‚    â”œâ”€â”€â”€ History
â”‚    â”œâ”€â”€â”€ Contributions
â”‚    â”œâ”€â”€â”€ RFID
â”‚    â””â”€â”€â”€ Flags (with Badge)
â”‚
â”œâ”€â”€â”€ FlagStatusBanner (if flagStatus != "good")
â”‚    â”œâ”€â”€â”€ Icon
â”‚    â”œâ”€â”€â”€ Title
â”‚    â”œâ”€â”€â”€ Message
â”‚    â”œâ”€â”€â”€ Score
â”‚    â””â”€â”€â”€ Contact Support Button (if required)
â”‚
â”œâ”€â”€â”€ Content (when selectedTab == 5)
â”‚    â””â”€â”€â”€ FlagsTab
â”‚         â”œâ”€â”€â”€ FlagStatusCard
â”‚         â”‚    â”œâ”€â”€â”€ Account Status
â”‚         â”‚    â”œâ”€â”€â”€ Flag Score
â”‚         â”‚    â””â”€â”€â”€ FlagStatusBadge
â”‚         â”‚
â”‚         â””â”€â”€â”€ ActiveFlagsList
â”‚              â””â”€â”€â”€ FlagItem (for each flag)
â”‚                   â”œâ”€â”€â”€ Header (Icon, Type, Points)
â”‚                   â”œâ”€â”€â”€ Message
â”‚                   â”œâ”€â”€â”€ Details
â”‚                   â”œâ”€â”€â”€ Timestamp & Severity
â”‚                   â””â”€â”€â”€ Resolve Button
â”‚
â””â”€â”€â”€ OR BlockedAccessScreen (if isSuspended)
     â”œâ”€â”€â”€ Block Icon
     â”œâ”€â”€â”€ Title ("Account Suspended")
     â”œâ”€â”€â”€ Message
     â”œâ”€â”€â”€ Flag Score
     â””â”€â”€â”€ Contact Support Button
```

## Real-time Update Flow

```
Admin Panel                    Firebase                    Driver App
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                  â”€â”€â”€â”€â”€â”€â”€â”€â”€                    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  Creates Flag                    â”‚                             â”‚
      â”‚                           â”‚                             â”‚
      â”‚â”€â”€â”€â”€ Write â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                             â”‚
      â”‚  flagScore: 75             â”‚                             â”‚
      â”‚  flagStatus: "monitored"   â”‚                             â”‚
      â”‚                            â”‚                             â”‚
      â”‚                            â”‚â”€â”€â”€â”€ onDataChange â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
      â”‚                            â”‚                             â”‚
      â”‚                            â”‚                       State Updates
      â”‚                            â”‚                       flagScore = 75
      â”‚                            â”‚                       flagStatus = "monitored"
      â”‚                            â”‚                             â”‚
      â”‚                            â”‚                       UI Recomposes
      â”‚                            â”‚                       Banner Appears âœ…
      â”‚                            â”‚                             â”‚
                                                                 â”‚
  Resolves Flag                   â”‚                             â”‚
      â”‚                           â”‚                             â”‚
      â”‚â”€â”€â”€â”€ Write â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                             â”‚
      â”‚  flagScore: 0              â”‚                             â”‚
      â”‚  flagStatus: "good"        â”‚                             â”‚
      â”‚                            â”‚                             â”‚
      â”‚                            â”‚â”€â”€â”€â”€ onDataChange â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
      â”‚                            â”‚                             â”‚
      â”‚                            â”‚                       State Updates
      â”‚                            â”‚                       flagScore = 0
      â”‚                            â”‚                       flagStatus = "good"
      â”‚                            â”‚                             â”‚
      â”‚                            â”‚                       UI Recomposes
      â”‚                            â”‚                       Banner Disappears âœ…
```

## File Dependencies

```
DriverInterface.kt
â”‚
â”œâ”€â”€â”€ imports FlagComponents.kt
â”‚    â”œâ”€â”€â”€ FlagStatusBanner
â”‚    â”œâ”€â”€â”€ FlagStatusBadge
â”‚    â”œâ”€â”€â”€ ActiveFlagsList
â”‚    â””â”€â”€â”€ BlockedAccessScreen
â”‚
â”œâ”€â”€â”€ imports EnhancedBookingViewModel
â”‚    â”œâ”€â”€â”€ observeDriverFlagData()
â”‚    â””â”€â”€â”€ observeDriverFlags()
â”‚
â””â”€â”€â”€ imports FlagModels.kt
     â”œâ”€â”€â”€ DriverFlag
     â”œâ”€â”€â”€ DriverFlagData
     â””â”€â”€â”€ FlagConstants

EnhancedBookingViewModel.kt
â”‚
â””â”€â”€â”€ imports TODARepository
     â”‚
     â””â”€â”€â”€ imports FirebaseRealtimeDatabaseService
          â”‚
          â””â”€â”€â”€ Firebase Database
```

## Security Model

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          Firebase Security Rules                 â”‚
â”‚                                                  â”‚
â”‚  "drivers": {                                    â”‚
â”‚    "$driverId": {                                â”‚
â”‚      ".read": "$driverId === auth.uid",          â”‚
â”‚      ".write": false  â† Driver CANNOT write      â”‚
â”‚    }                                             â”‚
â”‚  },                                              â”‚
â”‚                                                  â”‚
â”‚  "driverFlags": {                                â”‚
â”‚    "$driverId": {                                â”‚
â”‚      ".read": "$driverId === auth.uid",          â”‚
â”‚      ".write": false  â† Driver CANNOT write      â”‚
â”‚    }                                             â”‚
â”‚  }                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Security Features:**
- âœ… Drivers can only READ their own flag data
- âœ… Drivers CANNOT modify flag scores
- âœ… Drivers CANNOT resolve flags
- âœ… Only admin panel can write to flag data
- âœ… Authentication required (auth.uid)

---

**Last Updated:** November 4, 2025
